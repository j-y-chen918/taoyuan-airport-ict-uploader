<!doctype html>
<html lang="zh">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>上傳實習照片</title>
<style>
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;max-width:560px;margin:20px auto;padding:0 16px}
  h1{font-size:20px}
  label{display:block;margin:.8em 0 .3em}
  input,button,textarea{font:inherit}
  .box{border:1px solid #ddd;border-radius:10px;padding:12px}
  .ok{color:#0a7a0a}
  .err{color:#b00020}
</style>
<h1>上傳實習照片</h1>

<div class="box">
  <label>照片（jpg/png/webp）</label>
  <input id="file" type="file" accept="image/*" />

  <label>標題</label>
  <input id="title" type="text" placeholder="照片要顯示的名稱" style="width:100%" />

  <label>上傳金鑰</label>
  <input id="key" type="password" placeholder="向管理員索取" style="width:100%" />

  <p style="margin-top:12px">
    <button id="btn">上傳</button>
  </p>
  <div id="msg"></div>
</div>

<script>
async function toDataURL(file){
  // 手機相片通常很大，這裡縮到 2000px 內，壓成 jpeg 品質 0.85
  const img = await new Promise(r=>{
    const i = new Image(); i.onload=()=>r(i); i.src = URL.createObjectURL(file);
  });
  const max = 2000;
  let {width:w,height:h} = img;
  if (w>max || h>max){
    const s = Math.min(max/w, max/h); w=Math.round(w*s); h=Math.round(h*s);
  }
  const c=document.createElement('canvas'); c.width=w; c.height=h;
  const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,w,h);
  return c.toDataURL('image/jpeg', 0.85);
}

document.getElementById('btn').onclick = async ()=>{
  const f = document.getElementById('file').files[0];
  const title = document.getElementById('title').value.trim();
  const key = document.getElementById('key').value.trim();
  const msg = document.getElementById('msg');
  msg.className=''; msg.textContent='';

  if(!f){ msg.className='err'; msg.textContent='請選一張照片'; return; }
  if(!key){ msg.className='err'; msg.textContent='請輸入上傳金鑰'; return; }

  msg.textContent='上傳中…（依網速需數秒）';
  try{
    const imageBase64 = await toDataURL(f);
    const r = await fetch('/.netlify/functions/upload', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ imageBase64, title, key })
    });
    const j = await r.json().catch(()=> ({}));
    if(r.ok && j.ok){
      msg.className='ok';
      msg.textContent = `上傳成功：${j.index}｜${j.title || j.filename}`;
      // 清空
      document.getElementById('file').value='';
      document.getElementById('title').value='';
    }else{
      msg.className='err';
      msg.textContent = '上傳失敗：' + (j && (j.message || j.error) || await r.text());
    }
  }catch(e){
    msg.className='err';
    msg.textContent = '錯誤：' + e.message;
  }
};
</script>
</html>
